<html>
<head>
<meta charset="utf-8">
<title>PopularSynth v0.2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<script src="./Tone.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="./scripts/jquery.min.js"></script>
<script src="./scripts/draggabilly.js"></script>
<script src="https://tonejs.github.io/Logo/build/Logo.js"></script>
<script src="./scripts/StartAudioContext.js"></script>
<script src="./scripts/Interface.js"></script>
<script type="text/javascript" src="./p5.js"></script>
<link rel="stylesheet" type="text/css" href="./examples.css">	
<script>
// jshint ignore: start
</script>
</head>
<body>
<div id="Content" class="FullScreen">
<div id="Title">Multi user Synth Network fun</div>
<div id="Explanation">  Waiting Your Role</div>
</div>
<script>
var serverIP = "192.168.0.109";
var socket = io('http://'+ serverIP +':8000');
var playTeam ;
var myId;
var cutoffPos = 500 ;
var oscillators = [];
var bassFreq = 32;

var filter1 = new Tone.Filter(1,"lowpass",-24).toMaster();
var reverb = new Tone.JCReverb(0.8).connect(filter1);
var vibrato = new Tone.Vibrato(2, 0.8).connect(reverb);
var delay = new Tone.FeedbackDelay(0.200, 0.6).connect(vibrato);
 
filter1.Q.value = 1;
filter1.gain.value = 1.5;	
reverb.wet.value = 0.8;
    
Tone.context.latencyHint = "interactive";  // "balanced" "playback" "interactive"

socket.on('connect', () => {			// Instance ID
 myId = socket.id;   					
});
socket.on('clientsIDS', function(data) { // Users list stuff
	var myListPos = data.indexOf(myId);			// Group % 3 for now
	playTeam =  myListPos % 3;
});
        
	for (var i = 0; i < 4; i++){
		oscillators.push(new Tone.Oscillator({
			"frequency" : bassFreq * i,
			"type" : "sawtooth10" ,
			"volume" : -Infinity,
			"detune" : Math.random() * 10,
			}).start().connect(delay));
		}
    
var lfo2Range = 500;
var lfo2= new Tone.LFO("4hz",cutoffPos,lfo2Range).stop();
    lfo2.connect(filter1.frequency);
     

setTimeout(function(){						//User filter1 actions
	if(playTeam === 0){
		oscillators.forEach(function(osc, i){
		osc.type = "sine";
		document.getElementById("Explanation").innerHTML = "You are A Sine wave";
		});
		}
	if(playTeam === 1){
		oscillators.forEach(function(osc){
		osc.type = "sawtooth10";
		document.getElementById("Explanation").innerHTML = "You are A Saw wave!";
		});
		}
	if(playTeam === 2){
		oscillators.forEach(function(osc){
		osc.type = "square";
		document.getElementById("Explanation").innerHTML = "You are a Square Wave!";
		});
		}			
	},1000);
Interface.Slider({
			name : "Pitch",
			min : 0.5,
			max : 3.0,
            initial : 1,
			value : 1,
			drag : function(value){
				if(playTeam === 0){
                    oscillators.forEach(function(osc, i){
					osc.frequency.rampTo(4*(bassFreq * i * value), 0.2);
				});
					}
                if(playTeam === 1){
                        oscillators.forEach(function(osc, i){
					       osc.frequency.rampTo(bassFreq * i * value, 0.2);
				            });
				}
                if(playTeam === 2){
                      oscillators.forEach(function(osc, i){
					osc.frequency.rampTo(2*(bassFreq * i * value), 0.2);
				});
                }
        }
    });
	Interface.Slider({
			tone : filter1,
            param : "frequency",
			axis : "x",
            initial: 100,
			min : 40,
			max : 20000,
			exp : 4,
			drag : function(value){
                 cutoffPos = filter1.frequency.value;
                lfo2.min = cutoffPos;
                lfo2.max = cutoffPos + lfo2Range;
               
			},
		});
	Interface.Slider({
			param : "frequency",
			name : "AM",
			tone : vibrato,
			axis : "x",
			min : 0,
			max : 15,
			exp : 1,
			initial : 0,
			drag : function(value){
				vibrato.depth.value = value / 15;
				 delay.delayTime.rampTo(value/15,0.4);
                 delay.feedback.rampTo((value/15,0.1)+0.4);
              
			},
		});
	Interface.Button({
			text : "Play",
			activeText : "Stop",
			type : "toggle",
			key : 32, //spacebar
			start : function(){
				oscillators.forEach(function(osc){
					osc.volume.rampTo(-28, 0.3);
				});
			},
			end : function(){
				oscillators.forEach(function(osc){
					osc.volume.rampTo(-Infinity, 1);
				});
			},
		});
	Interface.Button({
			text :       "lfo off",
			activeText : "lfo on",
			type :        "toggle",
			start : function(){
                   	 lfo2.start();
			},
			end : function(){
                 lfo2.stop();
			},
		});
    Interface.Slider({
			name : "Speed LFO",
			min : 0.01,
			max : 30,
			exp : 2.5,
			value : 1,
			drag : function(value){
				lfo2.frequency.rampTo(value, 0.08);
			},
		});	
     Interface.Slider({
			name : "LFO Range",
			min : 200,
			max : 5000,
			exp : 2.5,
			value : 200,
			drag : function(value){
				lfo2Range = value;
                lfo2.min = cutoffPos;
                lfo2.max =cutoffPos+lfo2Range;
			},
		});	
									/*// ACCxyz functions
  if (window.DeviceMotionEvent == undefined) {
        //No accelerometer is present. Use buttons. 
        alert("no accelerometer");
    }
    else {
        alert("accelerometer found");
        window.addEventListener("devicemotion", accelerometerUpdate, true);
    }
	
	function accelerometerUpdate(e) {
   var aX = event.accelerationIncludingGravity.x*1;
   var aY = event.accelerationIncludingGravity.y*1;
   var aZ = event.accelerationIncludingGravity.z*1;
   var calc = (Math.round10(10 + aX,-2) *100);
}
///////////////////////////////*/

</script>
    <script src="./sketch.js"></script>
</body>
</html>