<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
<title>Poly Jam test</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<script src="./Tone.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="./scripts/jquery.min.js"></script>
<script src="./scripts/draggabilly.js"></script>
<script src="https://tonejs.github.io/Logo/build/Logo.js"></script>
<script src="./scripts/StartAudioContext.js"></script>
<script src="./scripts/Interface.js"></script>
<link rel="stylesheet" type="text/css" href="./examples.css">	
<script>
// jshint ignore: start
</script>
</head>
<body>
<div id="Content" class="FullScreen">
<div id="Title">Multi Synth Network fun</div>
<div id="acc">  Waiting Your Role</div>
</div>

<script>

var socket = io('http://192.168.0.2:8000');
var playTeam ;
var myId;

socket.on('connect', () => {			// Instance ID
 myId = socket.id;   					
});
socket.on('clientsIDS', function(data) { // Users list stuff
	var myListPos = data.indexOf(myId);			// Group % 3 for now
	playTeam =  myListPos % 3;
});

var oscillators = [];
var bassFreq = 32;
Tone.context.latencyHint = 'interactive'

	var filter = new Tone.Filter(300,"lowpass",-24).toMaster();
	var reverb = new Tone.JCReverb(0.8).connect(filter);
	var vibrato = new Tone.Vibrato(2, 0.8).connect(reverb);
	var delay = new Tone.FeedbackDelay(0.200, 0.4).connect(vibrato);
	
filter.Q.value = 5;
filter.gain.value = 2;	
reverb.wet.value = 0.9;

		for (var i = 0; i < 8; i++){
			oscillators.push(new Tone.Oscillator({
				"frequency" : bassFreq * i,
				"type" : "sawtooth10" ,
				"volume" : -Infinity,
				"detune" : Math.random() * 30 - 15,
			}).start().connect(delay));
		}
	var lfo2= new Tone.LFO("4hz",100,1000).stop();
	var lfo = new Tone.LFO(0.03,0.0,50).stop();
		lfo.connect(vibrato.frequency);
		lfo2.connect(filter.frequency);
		vibrato.frequency.value = 0;
		vibrato.depth.value = 0;
	Interface.Slider({
			name : "Pitch",
			min : 0.5,
			max : 3.0,
			value : 1,
			drag : function(value){
				oscillators.forEach(function(osc, i){
				if(playTeam === 0){
					osc.frequency.rampTo(Math.round((bassFreq * i * value)*8), 0.03);
					console.log(osc.frequency.value+" hz");
					}
				if(playTeam === 1){
					osc.frequency.rampTo(bassFreq * i * value, 0.03);
					}
				if(playTeam === 2){
					osc.frequency.rampTo(2*bassFreq * i * value, 0.03);
					}						
				});
			},
		});	
	Interface.Slider({
			param : "frequency",
			name : "freq",
			tone : filter,
			axis : "x",
			min : 80,
			max : 20000,
			exp : 3,
			drag : function(value){
				
			},
		});
	Interface.Slider({
			param : "frequency",
			name : "AM",
			tone : vibrato,
			axis : "x",
			min : 0,
			max : 30,
			exp : 1,
			initial : 0,
			drag : function(value){
				vibrato.depth.value = value / 30;
				console.log("AM Freq "+vibrato.frequency.value + " depth :"+ vibrato.depth.value);
			},
		});
	Interface.Button({
			text : "Play",
			activeText : "Stop",
			type : "toggle",
			key : 32, //spacebar
			start : function(){
				oscillators.forEach(function(osc){
					osc.volume.rampTo(-30, 1);
				});
			},
			end : function(){
				oscillators.forEach(function(osc){
					osc.volume.rampTo(-Infinity, 1);
				});
			},
		});
	Interface.Button({
			text : "lfo off",
			activeText : "lfo on",
			type : "toggle",
			key : 32, //spacebar
			start : function(){
					lfo.start();
					lfo2.start();
			},
			end : function(){
					
					lfo.stop();
					lfo2.stop();
					
			},
		});
    Interface.Slider({
			name : "Speed LFO",
			min : 0.01,
			max : 30,
			exp : 2.5,
			value : 1,
			drag : function(value){
				lfo2.frequency.rampTo(value, 0.08);
			},
		});	
									/*// ACCxyz functions
  if (window.DeviceMotionEvent == undefined) {
        //No accelerometer is present. Use buttons. 
        alert("no accelerometer");
    }
    else {
        alert("accelerometer found");
        window.addEventListener("devicemotion", accelerometerUpdate, true);
    }
	
	function accelerometerUpdate(e) {
   var aX = event.accelerationIncludingGravity.x*1;
   var aY = event.accelerationIncludingGravity.y*1;
   var aZ = event.accelerationIncludingGravity.z*1;
   var calc = (Math.round10(10 + aX,-2) *100);
}
///////////////////////////////*/
setTimeout(function(){				//User Filter actions
	if(playTeam === 0){
		oscillators.forEach(function(osc, i){
		osc.type = "sine";
		document.getElementById("acc").innerHTML = "You are A Sine wave";
		});
		}
	if(playTeam === 1){
		oscillators.forEach(function(osc){
		osc.type = "sawtooth10";
		document.getElementById("acc").innerHTML = "You are A Saw wave!";
		});
		}
	if(playTeam === 2){
		oscillators.forEach(function(osc){
		osc.type = "square";
		document.getElementById("acc").innerHTML = "You are a Square Wave!";
		});
		}			
		},1000);
</script>
</body>
</html>